' Gambas class file

''' this its the generic class like interfaces in JavaEE, 
''' defines And provides general procedures Like Open port common To all specific printers classes


'' to set the port ot use
Public puerto As String = "/dev/ttyS1"

'' abstractin port serial to use
Public SComm As SerialPort

'' used in manager class to access data in port buffer
Property Read dataread As String

'' buffer to read by dataread property
Private databuffer As String = ""

'' output nformation as kind of log, print in ide some stdour to gambas ide console, due its just example
Private Sub printerror()
  
  Print Error.Text & " at " & Error.Where & " in " & Error.Class.Name
  
End


' those methods will be generic and common for all the specific printer class


'' generic open port procedure
Public Function op()
    Try SComm.Close()
    SComm = New SerialPort As "SComm"
    SComm.PortName = puerto
    SComm.Speed = 9600
    SComm.Parity = 0  ' setup el dispositivo como dice en pagina 5 (13 del pdf) del manual VMAX libreria impresora fiscal 200A3
    SComm.DataBits = 8
    SComm.StopBits = 1
    SComm.FlowControl = 2
    Try SComm.Open()
    If Error Then printerror
    databuffer = ""
Catch
  Try SComm.Open()
  If Error Then printerror
  If Error Then Error.Propagate()
End

'' generic close port procedure
Public Sub cp()
    Try SComm.Close()
    Catch
        Print " error " & Error.Text
End

' this event will be triggered in read operations by the stream when data its available
Public Sub SComm_Read()
   Dim buffers As String = ""
  Read #SComm, buffers, Lof(SComm)
   databuffer &= buffers
End

' IMPORTANTE: el evento READ debe ser sobrescrito , 
' porque hay que esperar data de la impresora segun lso tiempos de esta
' y cada impresora es distinta, con tiempos distintos y mensajes/proptocolos distintos


'' generic read port buffer data, this method only will read lasted not readed info from the data buffer class
Public Sub rp()
   Dim start As Date = Now
   Dim buffers As String = ""
   If IsNull(databuffer) Then
    Do
      Wait 0.1
      Read #SComm, buffers, Lof(SComm)
      databuffer &= buffers
    Loop Until DateDiff(start, Now, gb.Millisecond) > 500
   Endif
End


Private Function dataread_Read() As String

  Dim returndata As String = ""
  returndata = databuffer
  databuffer = Null ' acts as semaphore
  Return returndata

End
